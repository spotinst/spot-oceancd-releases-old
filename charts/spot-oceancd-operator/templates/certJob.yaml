apiVersion: batch/v1
kind: Job
metadata:
  name: spot-oceancd-operator-installer
  labels:
    app: spot-oceancd-operator-installer
    {{- include "spot-oceancd-operator.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      serviceAccountName: spot-oceancd-operator-installer-service-account
      containers:
        - name: spot-oceancd-operator-installer
          image: spotinst/spot-oceancd-controller-installer:helm
          imagePullPolicy: Always
          command: ["./installation.sh"]
          args:
            - "--service"
            - "spot-oceancd-controller-svc"
            - "--webhook"
            - "controller.oceancd.spot.io"
            - "--secret"
            - "spot-oceancd-controller-tls"
            - "--namespace"
            - {{ .Release.Namespace }}
            - "--token"
            - {{ .Values.token | required "Spot token is required"}}
            - "--apiurl"
            - {{ .Values.apiUrl }}
            - "--clusterId"
            - {{ .Values.clusterId | required "Cluster ID is required"}}
            - "--saasurl"
            - {{ .Values.saasUrl }}
      restartPolicy: Never
  backoffLimit: 1
